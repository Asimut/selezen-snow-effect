/*!
 * Snow Effect by Selezen v1.0.2
 * Created by Selezen, © 2024
 */
(function() {
    'use strict';
    
    // Перевіряємо наявність jQuery кожні 100мс
    function waitForJQuery(callback) {
        console.log('Перевірка наявності jQuery...');
        if (window.jQuery) {
            console.log('jQuery знайдено');
            callback(window.jQuery);
        } else {
            console.log('Очікування jQuery...');
            // Завантажуємо jQuery якщо його немає
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js';
            script.onload = function() {
                console.log('jQuery завантажено');
                callback(window.jQuery);
            };
            document.head.appendChild(script);
        }
    }

    // Головна функція ініціалізації снігу
    function initSnowEffect(jQuery) {
        var $ = jQuery;
        console.log('Ініціалізація ефекту снігу');

        // Лічильник активних сніжинок
        let activeSnowflakes = 0;
        const MAX_SNOWFLAKES = 5;

        // Налаштування за замовчуванням
        const defaultSettings = {
            character: "❄",
            speed: 50000,
            frequency: 12000,
            color: "#0CB5ED",
            blur: false,
            enabled: true,
            small: 2,
            large: 4,
            wind: 2,
            windVariance: 1,
            startOpacity: 0.2,
            endOpacity: 0,
            overflow: "hidden",
            zIndex: 9999
        };

        // Глобальний об'єкт для керування снігом
        window.SnowEffect = {
            settings: defaultSettings,
            
            // Ініціалізація з налаштуваннями з Google таблиці
            init: async function(scriptUrl) {
                console.log('Завантаження налаштувань з Google Таблиці...');
                try {
                    const response = await fetch(scriptUrl);
                    const data = await response.json();
                    console.log('Отримані налаштування:', data);
                    
                    Object.assign(this.settings, data);
                    
                    if (this.settings.enabled) {
                        console.log('Ефект снігу увімкнено');
                        this.stop();
                        this.start();
                    } else {
                        console.log('Ефект снігу вимкнено');
                        this.stop();
                    }
                } catch (error) {
                    console.error('Помилка завантаження налаштувань:', error);
                }
            },

            // Запуск ефекту снігу
            start: function() {
                console.log('Запуск ефекту снігу');
                
                // Створюємо контейнер для сніжинок
                const $container = $('<div>')
                    .addClass('snow-container')
                    .css({
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        pointerEvents: 'none',
                        overflow: this.settings.overflow,
                        zIndex: this.settings.zIndex
                    })
                    .appendTo('body');

                // Функція створення сніжинки
                const createFlake = () => {
                    if (!this.settings.enabled || activeSnowflakes >= MAX_SNOWFLAKES) return;

                    activeSnowflakes++;
                    
                    // Розрахунок параметрів сніжинки
                    const fontSize = Math.random() * (this.settings.large - this.settings.small) + this.settings.small;
                    const startX = Math.random() * window.innerWidth;
                    const endX = startX + Math.random() * this.settings.wind * 2 - this.settings.wind;
                    const endY = window.innerHeight;
                    const rotation = Math.random() * this.settings.windVariance * 2 - this.settings.windVariance;
                    const speed = this.settings.speed * (0.8 + Math.random() * 0.4);

                    // Створення елементу сніжинки
                    const $flake = $('<span>')
                        .addClass('snowflake')
                        .html(this.settings.character)
                        .css({
                            position: 'absolute',
                            top: -fontSize,
                            left: startX,
                            color: this.settings.color,
                            fontSize: fontSize + 'px',
                            opacity: this.settings.startOpacity,
                            transition: `transform ${speed/1000}s linear, opacity ${speed/1000}s ease-in-out`,
                            transform: 'rotate(0deg)'
                        })
                        .appendTo($container);

                    // Анімація сніжинки
                    setTimeout(() => {
                        if (!this.settings.enabled) {
                            activeSnowflakes--;
                            $flake.remove();
                            return;
                        }
                        $flake.css({
                            transform: `translate(${endX - startX}px, ${endY}px) rotate(${rotation}deg)`,
                            opacity: this.settings.endOpacity
                        });
                    }, 50);

                    // Видалення сніжинки після завершення анімації
                    setTimeout(() => {
                        if ($flake.parent().length) {
                            activeSnowflakes--;
                            $flake.remove();
                        }
                    }, speed + 1000);
                };

                // Функція генерації сніжинок
                const generateFlakes = () => {
                    if (this.settings.enabled && activeSnowflakes < MAX_SNOWFLAKES) {
                        createFlake();
                    }
                    if (this.settings.enabled) {
                        setTimeout(generateFlakes, this.settings.frequency);
                    }
                };

                generateFlakes();
            },

            // Зупинка ефекту снігу
            stop: function() {
                console.log('Зупинка ефекту снігу');
                $('.snow-container').remove();
                activeSnowflakes = 0;
            }
        };

        // URL Google скрипта
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxXDc1zV88D0nJxYtc3KoPn6WTiG9qIo2zlo9RSccHi7cpEMMFireralBh3q6p-5uVDLA/exec';
        
        // Запуск ефекту та налаштування оновлень
        window.SnowEffect.init(GOOGLE_SCRIPT_URL);
        
        // Перевірка оновлень кожні 5 секунд
        setInterval(function() {
            if (document.visibilityState === 'visible') {
                window.SnowEffect.init(GOOGLE_SCRIPT_URL);
            }
        }, 5000);
    }

    // Очікуємо завантаження сторінки і запускаємо ефект
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            waitForJQuery(initSnowEffect);
        });
    } else {
        waitForJQuery(initSnowEffect);
    }

})();